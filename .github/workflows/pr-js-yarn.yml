name: PR JS Yarn

on:
  workflow_call:
    inputs:
      os:
        description: "Runner OS to use"
        required: false
        type: string
        default: "ubuntu-latest"
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "24.x"
      ignore-commit-pattern:
        description: "Regex pattern for files to exclude from commit (skip commit if only these change)"
        type: string
        required: false
        default: "^dist/sw.*\\.js$"

jobs:
  pr-js-yarn:
    name: Yarn Build and Commit
    runs-on: ${{ inputs.os }}
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: "yarn"

      - name: Install Dependencies
        run: |
          echo "::group::ðŸš€ Running yarn install @ $(date '+%Y-%m-%d %H:%M:%S')"
          yarn install --network-timeout 1000000 --frozen-lockfile
          echo "::endgroup::"

      - name: Format Code
        run: |
          echo "::group::âœ¨ Running yarn format @ $(date '+%Y-%m-%d %H:%M:%S')"
          yarn format
          echo "::endgroup::"

      - name: Run Tests
        run: |
          echo "::group::ðŸ§ª Running yarn test-ci @ $(date '+%Y-%m-%d %H:%M:%S')"
          yarn test-ci
          echo "::endgroup::"

      - name: Build
        run: |
          echo "::group::ðŸ”¨ Running yarn build @ $(date '+%Y-%m-%d %H:%M:%S')"
          yarn build
          echo "::endgroup::"

      - name: Check for Meaningful Changes
        id: check-changes
        run: |
          changed_files=$(git diff --name-only && git diff --name-only --cached && git ls-files --others --exclude-standard)
          meaningful_files=$(echo "$changed_files" | grep -v '^$' | grep -v -E '${{ inputs.ignore-commit-pattern }}' || true)
          if [ -z "$meaningful_files" ]; then
            echo "Only ignored files changed, skipping commit."
            echo "should_commit=false" >> "$GITHUB_OUTPUT"
            git checkout -- . 2>/dev/null || true
          else
            echo "Meaningful changes detected:"
            echo "$meaningful_files"
            echo "should_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Changes
        if: steps.check-changes.outputs.should_commit != 'false'
        uses: EndBug/add-and-commit@v9
        with:
          message: "CI / CD - Format Updates Automatic Commit"
          default_author: github_actions
        continue-on-error: true
