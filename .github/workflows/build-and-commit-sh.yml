name: Common Build and Commit with NodeJS and Build.sh

on:
  workflow_call:
    inputs:
      node-version:
        description: "Node.js version to use"
        type: string
        required: false
        default: "24.x"
      early-exit-on-commit:
        description: "Exit with failure after committing so the workflow re-triggers with updated code"
        type: boolean
        required: false
        default: false
      ignore-commit-pattern:
        description: "Extended regex pattern matching git diff paths (no ./ prefix) to exclude from commit (skip commit if only these change)"
        type: string
        required: false
        default: "^dist/sw.*\\.js$"
      deploy-to-pages:
        description: "Deploy to GitHub Pages after build (only on push to main/master)"
        type: boolean
        required: false
        default: false

jobs:
  build:
    name: Node ${{ inputs.node-version }} - Build and Commit
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write

    env:
      is_os_darwin_mac: 0
      is_os_window: 0
      is_os_wsl: 0
      is_os_ubuntu: 1
      is_os_chromeos: 0
      is_os_mingw64: 0
      is_os_android_termux: 0

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Node.js
        continue-on-error: true
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: ${{ hashFiles('package-lock.json') != '' && 'npm' || '' }}

      - name: Install Dependencies
        continue-on-error: true
        run: |
          if [ -f package-lock.json ]; then
            echo "::group::ðŸš€ Running npm ci @ $(date '+%Y-%m-%d %H:%M:%S')"
            npm ci
            echo "::endgroup::"
          elif [ -f package.json ]; then
            echo "::group::ðŸš€ Running npm install @ $(date '+%Y-%m-%d %H:%M:%S')"
            npm install
            echo "::endgroup::"
          else
            echo "â­ï¸ Skipping. No package.json found."
          fi

      - name: Build
        run: |
          if [ -f Makefile ]; then
            echo "::group::ðŸ”¨ Running make build @ $(date '+%Y-%m-%d %H:%M:%S')"
            make build
            echo "::endgroup::"
          elif [ -f build.sh ]; then
            echo "::group::ðŸ”¨ Running build.sh @ $(date '+%Y-%m-%d %H:%M:%S')"
            bash build.sh
            echo "::endgroup::"
          else
            echo "â­ï¸ Skipping build (no Makefile or build.sh found)"
          fi

      - name: Test
        run: |
          if [ -f Makefile ]; then
            echo "::group::ðŸ§ª Running make test @ $(date '+%Y-%m-%d %H:%M:%S')"
            make test
            echo "::endgroup::"
          elif [ -f test.sh ]; then
            echo "::group::ðŸ§ª Running test.sh @ $(date '+%Y-%m-%d %H:%M:%S')"
            bash test.sh
            echo "::endgroup::"
          else
            echo "â­ï¸ Skipping test (no Makefile or test.sh found)"
          fi

      - name: Format Code
        continue-on-error: true
        run: |
          if [ -f Makefile ]; then
            echo "::group::âœ¨ Running make format @ $(date '+%Y-%m-%d %H:%M:%S')"
            make format
            echo "::endgroup::"
          else
            echo "::group::âœ¨ Running format.sh @ $(date '+%Y-%m-%d %H:%M:%S')"
            curl -s -- https://raw.githubusercontent.com/synle/gha-workflow/refs/heads/main/format.sh | bash -s --
            echo "::endgroup::"
          fi

      - name: Check for Meaningful Changes
        id: check-changes
        run: |
          changed_files=$(git diff --name-only && git diff --name-only --cached && git ls-files --others --exclude-standard)
          meaningful_files=$(echo "$changed_files" | grep -v '^$' | grep -v -E '${{ inputs.ignore-commit-pattern }}' || true)
          if [ -z "$meaningful_files" ]; then
            echo "Only ignored files changed, skipping commit."
            echo "should_commit=false" >> "$GITHUB_OUTPUT"
            git checkout -- . 2>/dev/null || true
          else
            echo "Meaningful changes detected:"
            echo "$meaningful_files"
            echo "should_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Changes
        if: steps.check-changes.outputs.should_commit != 'false'
        id: commit
        uses: EndBug/add-and-commit@v9
        with:
          message: "CI / CD - Build artifacts and format code"
          default_author: github_actions

      - name: Early Exit on Commit
        if: inputs.early-exit-on-commit && steps.commit.outputs.committed == 'true'
        run: |
          echo "Changes were committed. Exiting early to re-trigger the workflow with updated code."
          exit 1

      - name: Upload Pages artifact
        if: inputs.deploy-to-pages && github.event_name == 'push'
        uses: actions/upload-pages-artifact@v3
        with:
          path: .

      - name: Deploy to GitHub Pages
        if: inputs.deploy-to-pages && github.event_name == 'push'
        id: deployment
        uses: actions/deploy-pages@v4
