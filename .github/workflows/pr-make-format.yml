name: PR Make Format

on:
  workflow_call:
    inputs:
      os:
        description: "Runner OS to use"
        required: false
        type: string
        default: "ubuntu-latest"
      node-version:
        description: "Node.js version to use"
        required: false
        type: string
        default: "24.x"
      ignore-commit-pattern:
        description: "Regex pattern for files to exclude from commit (skip commit if only these change)"
        type: string
        required: false
        default: "sw*.js"
      use-default-format-script:
        description: "Use the default remote format.sh script instead of local make format or npm run format"
        type: boolean
        required: false
        default: false

jobs:
  build:
    name: Make Format and Commit
    runs-on: ${{ inputs.os }}
    timeout-minutes: 20
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}

      - name: Format Code
        run: |
          if [ "${{ inputs.use-default-format-script }}" = "true" ]; then
            echo "::group::✨ Running default format.sh @ $(date '+%Y-%m-%d %H:%M:%S')"
            curl -s -- https://raw.githubusercontent.com/synle/gha-workflow/refs/heads/main/format.sh | bash -s --
            echo "::endgroup::"
          elif [ -f Makefile ] && grep -q '^format:' Makefile; then
            echo "::group::✨ Running make format @ $(date '+%Y-%m-%d %H:%M:%S')"
            make format
            echo "::endgroup::"
          elif [ -f package.json ]; then
            echo "::group::✨ Running npm run format (fallback) @ $(date '+%Y-%m-%d %H:%M:%S')"
            npm run format
            echo "::endgroup::"
          else
            echo "⏭️ Skipping format (no Makefile format target or package.json found)"
          fi

      - name: Check for Meaningful Changes
        id: check-changes
        run: |
          changed_files=$(git diff --name-only && git diff --name-only --cached && git ls-files --others --exclude-standard)
          meaningful_files=$(echo "$changed_files" | grep -v '^$' | grep -v -E '${{ inputs.ignore-commit-pattern }}' || true)
          if [ -z "$meaningful_files" ]; then
            echo "Only ignored files changed, skipping commit."
            echo "should_commit=false" >> "$GITHUB_OUTPUT"
            git checkout -- . 2>/dev/null || true
          else
            echo "Meaningful changes detected:"
            echo "$meaningful_files"
            echo "should_commit=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit Changes
        if: steps.check-changes.outputs.should_commit != 'false'
        uses: EndBug/add-and-commit@v9
        with:
          message: "CI / CD - Prettier Automatic Commit"
          default_author: github_actions
        continue-on-error: true
